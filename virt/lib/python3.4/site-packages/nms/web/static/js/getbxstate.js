/**
 * Continously get bx state by json
 */

bxUpdateInerval = 1 * 1000;  // ms

getBxState = function () {
    $.getJSON('/nms/_get_bx_queue/', function(bxQueue) { 
        $("#bx-queue").find("tr:gt(1)").remove();
        for (id in bxQueue) {
            bxEntry = "<tr>" +
            "<td>" + id + "</td>" + 
            "<td>" + bxQueue[id].name + "</td>" + 
            "<td>" + bxQueue[id].priority + "</td>" + 
            "<td>" + bxQueue[id].tasks + "</td>" + 
            "<td>" + bxQueue[id].current_waiting_time + "</td>" +
            "<td>" + bxQueue[id].max_waiting_time + "</td>" +
            "<td>" + bxQueue[id].content + "</td>" +
            "</tr>"
            $('#bx-queue tr:last').after(bxEntry);
        };
    });

    // Current tasks
    $.getJSON('/nms/_get_bx_info/', function(bxInfoDict) { 
        $("#bx-info").find("tr:gt(1)").remove();
        if (!bxInfoDict.has_job) {
            bxEntry = "<tr><td class='centered'  colspan=5 > Нет запущенных заявок </td></tr>"
            $('#bx-info tr:last').after(bxEntry);
        }
        else {
            for (var i = 0; i < bxInfoDict.jobs.length; i++) {
                var bxInfo = bxInfoDict.jobs[i];
                bxEntry = "<tr><td>" + bxInfo.job + "</td>"
                bxEntry += "<td>" + bxInfo.username + "</td>"
                bxEntry += "<td>" + bxInfo.GPU_count + "</td>"
                bxEntry += "<td>" + bxInfo.exec_time + "</td>"
                bxEntry += "<td>" + bxInfo.estimated_end + "</td> </tr>"
                $('#bx-info tr:last').after(bxEntry);
            }
        }
    });

    // Queue
    $.getJSON('/nms/_get_bx_schedule/', function(bxInfoDict) { 
        $("#bx-schedule").find("tr:gt(1)").remove();
        if (!bxInfoDict.has_job) {
            bxEntry = "<tr><td class='centered'  colspan=6 > Нет заявок в очереди </td></tr>"
            $('#bx-schedule tr:last').after(bxEntry);
        }
        else {
            for (var i = 0; i < bxInfoDict.jobs.length; i++) {
                var bxInfo = bxInfoDict.jobs[i];
                bxEntry = "<tr><td>" + bxInfo.job + "</td>"
                bxEntry += "<td>" + bxInfo.username + "</td>"
                bxEntry += "<td>" + bxInfo.GPU_count + "</td>"
                bxEntry += "<td>" + bxInfo.until_start + "</td>"
                bxEntry += "<td>" + bxInfo.reason + "</td>"
                bxEntry += "<td>" + bxInfo.time_in + "</td> </tr>"
                $('#bx-schedule tr:last').after(bxEntry);
            }
        }
    });
    // SO list
    $.getJSON('/nms/_get_bx_so_list/', function(bxInfoDict) { 
        $("#bx-so-list").find("tr:gt(1)").remove();
        if (!bxInfoDict.has_so) {
            bxEntry = "<tr><td class='centered'  colspan=4 > Нет способов обарботки </td></tr>"
            $('#bx-so-list tr:last').after(bxEntry);
        }
        else {
            for (var i = 0; i < bxInfoDict.so.length; i++) {
                var bxInfo = bxInfoDict.so[i];
                bxEntry = "<tr><td>" + bxInfo.id + "</td>"
                bxEntry += "<td>" + bxInfo.name + "</td>"
                bxEntry += "<td>" + bxInfo.num1 + "</td>"
                bxEntry += "<td>" + bxInfo.priority + "</td> </tr>"
                $('#bx-so-list tr:last').after(bxEntry);
            }
        }
    });

    // BX status
    $.getJSON('/nms/_get_bx_status/', function(bxInfoDict) { 
        $("#bx-status").find("tr:gt(0)").remove();
        var state = "failed-service";
        if (bxInfoDict.free == "0") {
            state = "ok-service";
        }

        bxEntry = "<tr><td class='" + state + "'>" + bxInfoDict.free + "</td><td>" + bxInfoDict.available + "</td></tr>"
        $('#bx-status tr:last').after(bxEntry);
    });

    // services states
    $.getJSON('/nms/_get_services_states/', function(servicesStates) { 
        $("#services-states").find("tr:gt(0)").remove();
        var len = servicesStates.length;
        serviceState = "<tr>"
        for (service in servicesStates) {
            var state = "failed-service";
            if (servicesStates[service]) {
                state = "ok-service";
            }
            serviceState += "<td class='centered " + state + "'>" + service + "</td>"
        }
        serviceState += "</tr>"
        $('#services-states tr:last').after(serviceState);
    });
    
    // Blink to indicate load
    blinkIndicator('#update-indicator');
    //blinkIndicator();
};

/**
 * Blinks with indicator
 */
blinkIndicator = function(id) {
    var indicator = $(id);
    //var originalColor = indicator.css('background-color');
    //indicator.css('background-color', '#ddd');
    setTimeout(function(){
         //indicator.css("background", originalColor);
         indicator.animate({ opacity: 0.1, }, 300);
         indicator.animate({ opacity: 1, }, 300);
    });
}
getBxState();
$(window.setInterval(getBxState, bxUpdateInerval));
