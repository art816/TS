{% extends "base.html" %}

{% block scripts %}
<script language="javascript" type="text/javascript" src="/static/js/highcharts/highstock.js"></script>
<script language="javascript" type="text/javascript" src="/static/js/highcharts/exporting.js"></script>

<script language="javascript" type="text/javascript" src="/static/js/plot.js"></script>
<script language="javascript" type="text/javascript" src="/static/js/set_param_values.js"></script>
<script language="javascript" type="text/javascript">
    // Create the chart
    $(function () {
        // Plot parameter sets.
        set_data_to_parameters("{{device.name}}");
        {% for param_gr_name in device.param_groups %}
            {% if device.param_groups[param_gr_name].do_plot %}
                var plot_parameters_{{param_gr_name}} = {
                    device_name: "{{device.name}}",
                    param_name: "{{param_gr_name}}",
                    param_fullname: "{{param_gr_name}}",
                    param_units: "",
                    ymax: {{device.param_groups[param_gr_name].maxy|tojson|safe}},
                    ymin: {{device.param_groups[param_gr_name].miny|tojson|safe}},
                    navigator_enabled: true,
                    height: 240,
                    has_title: false,
                    boundaries: {
                        errors: [
                        {% if device.param_groups[param_gr_name].boundaries.err_max is not none %}
                            {{ device.param_groups[param_gr_name].boundaries.err_max| tojson | safe}},
                        {%endif%}
                        {% if device.param_groups[param_gr_name].boundaries.err_min is not none %}
                            {{ device.param_groups[param_gr_name].boundaries.err_min| tojson | safe}},
                        {%endif%}
                        ],
                        warnings: [
                        {% if device.param_groups[param_gr_name].boundaries.warn_min is not none %}
                            {{ device.param_groups[param_gr_name].boundaries.warn_min| tojson | safe}},
                        {%endif%}
                        {% if device.param_groups[param_gr_name].boundaries.warn_max is not none %}
                            {{ device.param_groups[param_gr_name].boundaries.warn_max| tojson | safe}},
                        {%endif%}
                        ],
                    },
                };
                plot_parameter_set('#param_set_{{param_gr_name}}',
                         plot_parameters_{{param_gr_name}},
                         {{device.param_groups[param_gr_name].par_names |tojson|safe}},
                         {{device.param_groups[param_gr_name].par_full_names |tojson|safe}}); 
            {% endif %}
        {% endfor %}

        // Plot parameters.
        {% for param_name in device.main_parameters %}
        var plot_parameters_{{param_name}} = {
            device_name: "{{device.name}}",
            param_name: "{{device.params_dict[param_name].name}}",
            param_fullname: "{{device.params_dict[param_name].full_name}}",
            param_units: "{{device.params_dict[param_name].units}}",
            ymax: {% if device.params_dict[param_name].get_max_y() is none %}
                    null
                  {% else %}
                    {{device.params_dict[param_name].get_max_y()}}
                  {% endif %},
            ymin: {% if device.params_dict[param_name].get_min_y() is none %}
                    null
                  {% else %}
                    {{device.params_dict[param_name].get_min_y()}}
                  {% endif %},
            navigator_enabled: true,
                    height: 240,
            has_title: false,
            boundaries: {
                errors: [
                {% if device.params_dict[param_name].boundaries.err_max is not none %}
                    {{ device.params_dict[param_name].boundaries.err_max| tojson | safe}},
                {%endif%}
                {% if device.params_dict[param_name].boundaries.err_min is not none %}
                    {{ device.params_dict[param_name].boundaries.err_min| tojson | safe}},
                {%endif%}
                ],
                warnings: [
                {% if device.params_dict[param_name].boundaries.warn_min is not none %}
                    {{ device.params_dict[param_name].boundaries.warn_min| tojson | safe}},
                {%endif%}
                {% if device.params_dict[param_name].boundaries.warn_max is not none %}
                    {{ device.params_dict[param_name].boundaries.warn_max| tojson | safe}},
                {%endif%}
                ],
            }
        };
        plot_single_parameter("#param_{{param_name}}", plot_parameters_{{param_name}}, 4); 
        {% endfor %}

        // Dynamic upload of data in links.
        function set_values() {set_data_to_parameters("{{device.name}}");};
        window.setInterval(set_values, 3000);
        
    });
</script>
{% endblock %}

{% block title %} {{device.full_name}} {% endblock %}

{% block left %}
    <div class="device_menu" style='display: block-inline;'>
        {% include 'common/device_block.html' %}

        <div class="device_group" style='border-top: 1px solid #aaa;'>Параметры устройства</div>
        {% for param in device.params_dict.values() %}
            {% if param.visible %}
                <div class='param_entry'>
                    <div class='pname'>
                    <a class='wide_link' href="/nms/parameter/{{ device.name }}/{{param.name}}" title="{{param.name}} - {{param.desc}}">
                        {{param.desc}}</a>
                    </div>
                    <div class='alert_entry'>
                    {% if param.do_have_alerts %} <img width='16px' height='16px' src="/static/img/icons/alert_state.png"> {%endif%}
                    </div>
                    <div class='pvalue_container small-text'> <div class='pvalue ' id="param_value_{{param.name}}"></div> 
                        {% if not param.is_enum %}
                        {{param.units}}
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}

        {% for param_group in device.param_groups.values() %}
            <div class="device_group">{{param_group.full_name}}</div>
            <div class='list_cont' style="display: none;">
                <div class='param_entry'>
                    <div class='pname' style='width: 100%;'>
            <a class="wide_link" href="/nms/parameter_group/{{ device.name }}/{{param_group.name}}">
            Показать все </a>
                    </div>
                </div>
            {% for param in param_group.params %}
                <div class='param_entry'>
                    <div class='pname'>
                    <a class='wide_link' href="/nms/parameter/{{ device.name }}/{{param.name}}" title="{{param.name}} - {{param.desc}}">
                        {{param.desc}}</a>
                    </div>
                    <div class='alert_entry'>
                    {% if param.do_have_alerts %} <img width='16px' height='16px' src="/static/img/icons/alert_state.png"> {%endif%}
                    </div>
                    <div class='pvalue_container small-text'> <div class='pvalue ' id="param_value_{{param.name}}"></div> {{param.units}} </div>
                </div>
            {% endfor %}
            </div>
        {% endfor %}


    </div>
{% endblock %}
{% block right %}
    <div class = "right">    
        <center>
        {% set alerts = current_alerts %} 
        {% set block_type = "current alerts" %}
        {% set block_name = "Текущие внештатные ситуации" %}
        {% include 'common/alert_table.html' %}
        </center>
        <div class="box-decorate">
        Обновлять графики автоматически <input type="checkbox" id="do_update_plots" checked />
        </div>
        {% for param_gr_name in device.param_groups %}
        {%if device.param_groups[param_gr_name].do_plot %}
            <div class="small-plot">
                <div id="param_set_{{param_gr_name}}"></div>
            </div>
            {%endif%}
        {% endfor %}
        {% for param_name in device.main_parameters %}
        <div class="small-plot">
            <div id="param_{{param_name}}"></div>
        </div>
        {% endfor %}
    </div>
    <div style="clear:both"></div>
{% endblock %}
